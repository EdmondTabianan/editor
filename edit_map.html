<!DOCTYPE html>
<html>
<head>
  <title>Map Editor</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      height: 100vh; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      overflow: hidden;
      background: #1a1a1a;
      display: flex;
    }
    
    canvas { 
      border: 1px solid #444; 
      image-rendering: pixelated; 
      cursor: crosshair; 
      background: #222;
    }
    
    /* Main container with left map and right tiles */
    .main-container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }
    
    /* Left side: Map area */
    .map-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-width: 0; /* Allow shrinking */
    }
    
    /* Right side: Tile palette */
    .tile-area {
      width: 280px; /* Fixed width for tile panel */
      background: #2a2a2a;
      border-left: 1px solid #333;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
    }
    
    /* Ultra-compact controls */
    .main-controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      flex-wrap: nowrap;
      gap: 8px;
      min-height: 46px;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: nowrap;
      flex-shrink: 0;
    }
    
    button { 
      padding: 6px 10px; 
      cursor: pointer; 
      border: 1px solid #444;
      background: #333;
      color: #ddd;
      border-radius: 4px;
      font-size: 13px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 32px;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    button:hover {
      background: #3a3a3a;
      border-color: #555;
      transform: translateY(-1px);
    }
    
    /* File menu specific */
    .file-menu {
      position: relative;
    }
    
    .file-menu-btn {
      background: #2c5282;
      border-color: #2c5282;
      padding: 6px 12px;
      min-width: 70px;
    }
    
    .file-menu-btn:hover {
      background: #2b6cb0;
      border-color: #2b6cb0;
    }
    
    .file-menu-content {
      display: none;
      position: absolute;
      background: #333;
      min-width: 180px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      border: 1px solid #444;
      border-radius: 4px;
      z-index: 100;
      padding: 6px 0;
      top: 100%;
      left: 0;
      margin-top: 4px;
    }
    
    .file-menu-content.show {
      display: block;
    }
    
    .file-menu-item {
      display: block;
      width: 100%;
      padding: 8px 14px;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 13px;
      color: #ddd;
      height: auto;
    }
    
    .file-menu-item:hover {
      background: #3a3a3a;
    }
    
    .menu-divider {
      height: 1px;
      background: #444;
      margin: 6px 0;
    }
    
    /* Mode buttons */
    .mode-buttons button.active { 
      background: #2d3748; 
      color: #63b3ed;
      border-color: #4a5568;
      box-shadow: inset 0 0 0 1px #4a5568;
    }
    
    /* Zoom controls */
    .zoom-display {
      background: #2a2a2a;
      color: #ddd;
      padding: 0 10px;
      border: 1px solid #444;
      border-radius: 4px;
      min-width: 40px;
      text-align: center;
      font-size: 12px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Consolas', monospace;
      font-weight: 600;
    }
    
    .zoom-btn {
      width: 32px;
      padding: 0;
    }
    
    .zoom-1x {
      width: 36px;
    }
    
    /* Map container - takes most space */
    .map-container { 
      position: relative; 
      overflow: auto; 
      flex: 1;
      background: #222;
    }
    
    .coord-display { 
      position: absolute; 
      top: 8px; 
      left: 8px; 
      background: rgba(26, 26, 26, 0.95); 
      padding: 4px 10px; 
      font-size: 12px; 
      z-index: 10;
      border: 1px solid #444;
      border-radius: 4px;
      color: #ddd;
      font-family: 'Consolas', monospace;
      font-weight: 600;
    }
    
    /* Status bar */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 12px;
      background: #2a2a2a;
      border-top: 1px solid #333;
      font-size: 12px;
      color: #aaa;
      height: 34px;
      flex-shrink: 0;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    /* TILE AREA - Right side */
    .tile-header {
      padding: 14px 16px;
      background: #2c5282;
      color: white;
      border-bottom: 1px solid #2b6cb0;
    }
    
    .tile-header h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tile-info {
      margin-top: 6px;
      font-size: 12px;
      color: #a0c8ff;
      display: flex;
      justify-content: space-between;
    }
    
    /* Tile grid */
    .tile-grid-container {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .tile-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    .tile-item {
      position: relative;
      background: #333;
      border: 2px solid #444;
      border-radius: 6px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.2s;
      aspect-ratio: 1;
    }
    
    .tile-item:hover {
      border-color: #63b3ed;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    
    .tile-item.selected {
      border-color: #e53e3e;
      border-width: 3px;
      background: #3a2a2a;
    }
    
    .tile-preview {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
    }
    
    .tile-number {
      position: absolute;
      top: 4px;
      left: 4px;
      background: rgba(26, 26, 26, 0.9);
      color: #ddd;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Consolas', monospace;
      font-weight: 600;
    }
    
    .tile-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 26, 0.9);
      color: #ddd;
      font-size: 10px;
      padding: 4px;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .tile-checkbox {
      position: absolute;
      top: 4px;
      right: 4px;
      z-index: 2;
      width: 14px;
      height: 14px;
      cursor: pointer;
    }
    
    /* Empty state */
    .empty-tiles {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 40px;
      color: #666;
      text-align: center;
    }
    
    .empty-tiles .icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-tiles p {
      font-size: 14px;
      margin: 4px 0;
    }
    
    .empty-tiles .hint {
      font-size: 12px;
      color: #888;
      margin-top: 12px;
    }
    
    /* Tile limit warning */
    .tile-limit-warning {
      background: #4a2a2a;
      color: #fc8181;
      font-size: 11px;
      padding: 8px 12px;
      border-top: 1px solid #5a3a3a;
      display: none;
    }
    
    /* File inputs */
    .file-input-hidden {
      display: none;
    }
    
    /* Scrollbar styling */
    .tile-grid-container::-webkit-scrollbar {
      width: 6px;
    }
    
    .tile-grid-container::-webkit-scrollbar-track {
      background: #2a2a2a;
      border-radius: 3px;
    }
    
    .tile-grid-container::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 3px;
    }
    
    .tile-grid-container::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
    
    .map-container::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }
    
    .map-container::-webkit-scrollbar-track {
      background: #2a2a2a;
    }
    
    .map-container::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 5px;
    }
    
    .map-container::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }
    
    /* Tool icons */
    .tool-icon {
      font-size: 14px;
      line-height: 1;
    }
    
    /* Import button */
    .import-btn {
      background: #2d3748;
      border: 2px dashed #4a5568;
      color: #a0aec0;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      margin: 12px;
      transition: all 0.2s;
    }
    
    .import-btn:hover {
      background: #3d4758;
      border-color: #63b3ed;
      color: #63b3ed;
    }
  </style>
</head>
<body>

<div class="main-container">
  <!-- Left side: Map area -->
  <div class="map-area">
    <!-- Main Controls -->
    <div class="main-controls">
      <!-- Left: File Menu -->
      <div class="control-group">
        <div class="file-menu">
          <button class="file-menu-btn tool-icon" id="fileMenuBtn">
            üìÅ File ‚ñº
          </button>
          <div class="file-menu-content" id="fileMenuContent">
            <button class="file-menu-item" id="menuImportTiles">üì• Import Tiles...</button>
            <button class="file-menu-item" id="menuImportMap">üìÇ Import Map...</button>
            <div class="menu-divider"></div>
            <button class="file-menu-item" id="menuSaveMap">üíæ Save Map as TXT</button>
            <button class="file-menu-item" id="menuExportImage">üñºÔ∏è Export as PNG</button>
            <div class="menu-divider"></div>
            <button class="file-menu-item" id="menuClearMap" style="color: #fc8181;">üóëÔ∏è Clear Map</button>
          </div>
        </div>
      </div>
      
      <!-- Center: Mode Buttons -->
      <div class="control-group">
        <button id="modePlace" class="active tool-icon">üñåÔ∏è Place</button>
        <button id="modeSelect" class="tool-icon">üî≤ Select</button>
        <button id="clearSelectedAreaBtn" class="tool-icon">üóëÔ∏è Area</button>
        <button id="deselectAllBtn" class="tool-icon">‚úñÔ∏è Deselect</button>
      </div>
      
      <!-- Right: Zoom Controls -->
      <div class="control-group">
        <button id="fitMapBtn" class="tool-icon zoom-btn">üìê</button>
        <button id="zoomOutBtn" class="tool-icon zoom-btn">‚ûñ</button>
        <div class="zoom-display" id="zoomLevel">Fit</div>
        <button id="zoomInBtn" class="tool-icon zoom-btn">‚ûï</button>
        <button id="zoom1xBtn" class="tool-icon zoom-1x">1x</button>
      </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="importTileForMap" accept="image/png" multiple class="file-input-hidden"/>
    <input type="file" id="importMapTXT" accept=".txt" class="file-input-hidden"/>

    <!-- Map Container -->
    <div class="map-container" id="mapContainer">
      <div class="coord-display" id="coordDisplay">X:0 Y:0</div>
      <canvas id="mapEditor"></canvas>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <span id="mapInfo">Map: 50√ó50</span>
      </div>
      <div class="status-item">
        <span id="viewInfo">View: Fit</span>
      </div>
      <div class="status-item">
        <span id="selectedInfo">Selected: 0</span>
      </div>
      <div class="status-item">
        <span id="tileCountInfo">Tiles: 0/2000</span>
      </div>
    </div>
  </div>

  <!-- Right side: Tile palette -->
  <div class="tile-area">
    <div class="tile-header">
      <h2>üé® Tile Palette</h2>
      <div class="tile-info">
        <span id="tileInfo">No tiles imported</span>
        <span id="tileStats">0 tiles</span>
      </div>
    </div>
    
    <div class="import-btn" id="importTilesBtn">
      üì• Click to Import Tiles
    </div>
    
    <div class="tile-grid-container" id="tileGridContainer">
      <div class="empty-tiles" id="emptyTiles">
        <div class="icon">üé®</div>
        <p>No tiles imported yet</p>
        <p>Import PNG files to get started</p>
        <div class="hint">Supports 000-1999 numbered tiles</div>
      </div>
      <div class="tile-grid" id="tileGrid"></div>
    </div>
    
    <div class="tile-limit-warning" id="tileLimitWarning">
      ‚ö†Ô∏è Tile limit: 2000 (000-1999)
    </div>
  </div>
</div>

<!-- jQuery -->
<script src="jquery.js"></script>

<script>
// === Settings ===
const OriginalTileSize = 16;
const MIN_TileScale = 1;
const MAX_TileScale = 8;
let TileScale = 0; // 0 means "fit to screen"
const MapCols = 50;
const MapRows = 50;
const MAX_TILES = 2000; // Maximum number of tiles (000-1999)

// === Map Editor Variables ===
let tileLibrary = [];
let selectedTileIndices = new Set();
let selectedTileIndex = 0;
const map = [];

// Selection rectangle
let selectionRect = {
  startX: -1,
  startY: -1,
  endX: -1,
  endY: -1,
  isSelecting: false
};

// Editor mode: 'place' or 'select'
let editorMode = 'place';

// Canvas contexts
let mapEditorCtx;
let isFitToScreen = true;

// Initialize empty map
for (let y = 0; y < MapRows; y++) {
  map[y] = [];
  for (let x = 0; x < MapCols; x++) {
    map[y][x] = -1;
  }
}

// === Canvas Setup ===
const mapEditorCanvas = document.getElementById('mapEditor');
const mapContainer = document.getElementById('mapContainer');

// Calculate fit-to-screen zoom level
function calculateFitZoom() {
  const container = mapContainer;
  const containerWidth = container.clientWidth - 4;
  const containerHeight = container.clientHeight - 4;
  
  const maxWidthZoom = Math.floor(containerWidth / (MapCols * OriginalTileSize));
  const maxHeightZoom = Math.floor(containerHeight / (MapRows * OriginalTileSize));
  
  return Math.max(1, Math.min(maxWidthZoom, maxHeightZoom));
}

// Initialize map editor canvas
function initMapEditorCanvas() {
  let effectiveTileScale = TileScale;
  if (isFitToScreen) {
    effectiveTileScale = calculateFitZoom();
  }
  
  mapEditorCanvas.width = MapCols * OriginalTileSize * effectiveTileScale;
  mapEditorCanvas.height = MapRows * OriginalTileSize * effectiveTileScale;
  mapEditorCtx = mapEditorCanvas.getContext('2d');
}

// Update map canvas size based on zoom
function updateMapCanvasSize() {
  let effectiveTileScale = TileScale;
  if (isFitToScreen && TileScale === 0) {
    effectiveTileScale = calculateFitZoom();
  }
  
  mapEditorCanvas.width = MapCols * OriginalTileSize * effectiveTileScale;
  mapEditorCanvas.height = MapRows * OriginalTileSize * effectiveTileScale;
  drawMap();
  updateZoomDisplay();
  updateViewInfo();
}

// Update view information
function updateViewInfo() {
  const viewInfo = $('#viewInfo');
  if (isFitToScreen) {
    const fitZoom = calculateFitZoom();
    viewInfo.text(`View: ${fitZoom}x`);
  } else {
    viewInfo.text(`View: ${TileScale}x`);
  }
}

// === Map Editor Functions ===
function drawMap() {
  if (!mapEditorCtx) return;
  
  const effectiveTileScale = isFitToScreen && TileScale === 0 ? calculateFitZoom() : TileScale;
  
  // Clear map
  mapEditorCtx.fillStyle = '#222';
  mapEditorCtx.fillRect(0, 0, mapEditorCanvas.width, mapEditorCanvas.height);
  
  // Draw grid (only if zoom is at least 2x)
  if (effectiveTileScale >= 2) {
    mapEditorCtx.strokeStyle = '#333';
    mapEditorCtx.lineWidth = 1;
    
    for (let y = 0; y <= MapRows; y++) {
      mapEditorCtx.beginPath();
      mapEditorCtx.moveTo(0, y * OriginalTileSize * effectiveTileScale);
      mapEditorCtx.lineTo(mapEditorCanvas.width, y * OriginalTileSize * effectiveTileScale);
      mapEditorCtx.stroke();
    }
    for (let x = 0; x <= MapCols; x++) {
      mapEditorCtx.beginPath();
      mapEditorCtx.moveTo(x * OriginalTileSize * effectiveTileScale, 0);
      mapEditorCtx.lineTo(x * OriginalTileSize * effectiveTileScale, mapEditorCanvas.height);
      mapEditorCtx.stroke();
    }
  }
  
  // Draw tiles
  for (let y = 0; y < MapRows; y++) {
    for (let x = 0; x < MapCols; x++) {
      const tileIndex = map[y][x];
      if (tileIndex >= 0 && tileIndex < tileLibrary.length) {
        const tileCanvas = tileLibrary[tileIndex].canvas;
        mapEditorCtx.drawImage(
          tileCanvas,
          x * OriginalTileSize * effectiveTileScale,
          y * OriginalTileSize * effectiveTileScale,
          OriginalTileSize * effectiveTileScale,
          OriginalTileSize * effectiveTileScale
        );
      }
    }
  }
  
  // Draw selection rectangle
  if (editorMode === 'select' && selectionRect.startX >= 0 && selectionRect.startY >= 0 &&
      selectionRect.endX >= 0 && selectionRect.endY >= 0) {
    const cellSize = OriginalTileSize * effectiveTileScale;
    const x1 = Math.min(selectionRect.startX, selectionRect.endX);
    const y1 = Math.min(selectionRect.startY, selectionRect.endY);
    const x2 = Math.max(selectionRect.startX, selectionRect.endX);
    const y2 = Math.max(selectionRect.startY, selectionRect.endY);
    
    mapEditorCtx.strokeStyle = '#63b3ed';
    mapEditorCtx.lineWidth = 2;
    mapEditorCtx.setLineDash([5, 3]);
    mapEditorCtx.strokeRect(
      x1 * cellSize,
      y1 * cellSize,
      (x2 - x1 + 1) * cellSize,
      (y2 - y1 + 1) * cellSize
    );
    mapEditorCtx.setLineDash([]);
  }
}

// Extract number from filename for sorting
function extractTileNumber(filename) {
  const nameWithoutExt = filename.replace('.png', '').replace('.PNG', '');
  const match = nameWithoutExt.match(/\d+/);
  if (match) {
    const num = parseInt(match[0]);
    return Math.min(Math.max(num, 0), 1999);
  }
  const parsed = parseInt(nameWithoutExt);
  if (!isNaN(parsed)) {
    return Math.min(Math.max(parsed, 0), 1999);
  }
  return 0;
}

// Sort tile library by extracted numbers
function sortTileLibrary() {
  tileLibrary.sort((a, b) => {
    return extractTileNumber(a.name) - extractTileNumber(b.name);
  });
}

// Update tile count display
function updateTileCount() {
  $('#tileCountInfo').text(`Tiles: ${tileLibrary.length}/2000`);
  $('#tileStats').text(`${tileLibrary.length} tiles`);
  
  const warning = $('#tileLimitWarning');
  if (tileLibrary.length >= MAX_TILES * 0.9) {
    warning.show().css('background', '#5a2a2a');
    warning.text(`‚ö†Ô∏è Warning: ${tileLibrary.length}/2000 tiles`);
  } else if (tileLibrary.length >= MAX_TILES * 0.7) {
    warning.show().css('background', '#4a3a2a');
    warning.text(`${tileLibrary.length}/2000 tiles`);
  } else {
    warning.hide();
  }
}

// Update tile grid display
function updateTileGrid() {
  const tileGrid = $('#tileGrid');
  const emptyTiles = $('#emptyTiles');
  tileGrid.empty();
  
  if (tileLibrary.length === 0) {
    emptyTiles.show();
    $('#tileInfo').text('No tiles imported');
    return;
  }
  
  emptyTiles.hide();
  
  // Sort tiles before displaying
  sortTileLibrary();
  
  tileLibrary.forEach((tile, idx) => {
    const tileItem = $('<div>').addClass('tile-item');
    
    // Add selected class if this tile is selected
    if (selectedTileIndices.has(idx)) {
      tileItem.addClass('selected');
    }
    
    // Extract tile number
    const tileNumber = extractTileNumber(tile.name);
    const displayNumber = tileNumber.toString().padStart(3, '0');
    
    // Create preview canvas
    const previewCanvas = $('<canvas>').addClass('tile-preview');
    const ctx = previewCanvas[0].getContext('2d');
    previewCanvas[0].width = 64;
    previewCanvas[0].height = 64;
    
    // Draw tile preview (scaled up for visibility)
    ctx.imageSmoothingEnabled = false;
    ctx.drawImage(tile.canvas, 0, 0, 64, 64);
    
    // Add tile number overlay
    const numberOverlay = $('<div>').addClass('tile-number').text(displayNumber);
    
    // Add tile name (truncated)
    const name = tile.name.length > 12 ? tile.name.substring(0, 10) + '...' : tile.name;
    const nameOverlay = $('<div>').addClass('tile-name').text(name);
    
    // Add checkbox for multiple selection
    const checkbox = $('<input>').attr({
      type: 'checkbox',
      class: 'tile-checkbox'
    }).prop('checked', selectedTileIndices.has(idx));
    
    checkbox.on('click', function(e) {
      e.stopPropagation();
      if ($(this).prop('checked')) {
        selectedTileIndices.add(idx);
      } else {
        selectedTileIndices.delete(idx);
      }
      if (selectedTileIndices.size > 0) {
        selectedTileIndex = Array.from(selectedTileIndices)[0];
      }
      updateTileGrid();
    });
    
    tileItem.on('click', function(e) {
      if (e.shiftKey) {
        if (selectedTileIndices.has(idx)) {
          selectedTileIndices.delete(idx);
        } else {
          selectedTileIndices.add(idx);
        }
        if (selectedTileIndices.size > 0) {
          selectedTileIndex = Array.from(selectedTileIndices)[0];
        }
      } else {
        selectedTileIndex = idx;
        selectedTileIndices.clear();
        selectedTileIndices.add(idx);
      }
      updateTileGrid();
      updateSelectedInfo();
    });
    
    tileItem.append(previewCanvas, numberOverlay, nameOverlay, checkbox);
    tileGrid.append(tileItem);
  });
  
  // Update info display
  $('#tileInfo').text(`${tileLibrary.length} tiles loaded`);
  updateTileCount();
  updateSelectedInfo();
}

function updateZoomDisplay() {
  const zoomLevel = $('#zoomLevel');
  if (isFitToScreen && TileScale === 0) {
    zoomLevel.text('Fit');
  } else {
    zoomLevel.text(`${TileScale}x`);
  }
}

function updateSelectedInfo() {
  const selectedInfo = $('#selectedInfo');
  selectedInfo.text(`Selected: ${selectedTileIndices.size}`);
}

// === Event Listeners ===
function initEventListeners() {
  // File Menu functionality
  $('#fileMenuBtn').on('click', function(e) {
    e.stopPropagation();
    $('#fileMenuContent').toggleClass('show');
  });
  
  $(document).on('click', function() {
    $('#fileMenuContent').removeClass('show');
  });
  
  $('#fileMenuContent').on('click', function(e) {
    e.stopPropagation();
  });
  
  // File menu items
  $('#menuImportTiles').on('click', function() {
    $('#importTileForMap').click();
  });
  
  $('#menuImportMap').on('click', function() {
    $('#importMapTXT').click();
  });
  
  $('#menuSaveMap').on('click', function() {
    saveMapAsTXT();
  });
  
  $('#menuExportImage').on('click', function() {
    exportMapAsPNG();
  });
  
  $('#menuClearMap').on('click', function() {
    if (confirm('Clear the entire 50x50 map?')) {
      for (let y = 0; y < MapRows; y++) {
        for (let x = 0; x < MapCols; x++) {
          map[y][x] = -1;
        }
      }
      drawMap();
    }
  });
  
  // Import tiles button
  $('#importTilesBtn').on('click', function() {
    $('#importTileForMap').click();
  });
  
  // Deselect All button
  $('#deselectAllBtn').on('click', function() {
    selectedTileIndices.clear();
    if (tileLibrary.length > 0) {
      selectedTileIndex = 0;
      selectedTileIndices.add(0);
    }
    updateTileGrid();
  });
  
  // Map Editor Event Listeners
  let isDragging = false;

  function updateCoordDisplay(x, y) {
    $('#coordDisplay').text(`X:${x} Y:${y}`);
  }

  function getMapCoordinates(e) {
    const rect = mapEditorCanvas.getBoundingClientRect();
    const scrollLeft = mapContainer.scrollLeft;
    const scrollTop = mapContainer.scrollTop;
    
    const effectiveTileScale = isFitToScreen && TileScale === 0 ? calculateFitZoom() : TileScale;
    const x = Math.floor((e.clientX - rect.left + scrollLeft) / (OriginalTileSize * effectiveTileScale));
    const y = Math.floor((e.clientY - rect.top + scrollTop) / (OriginalTileSize * effectiveTileScale));
    
    return { x, y };
  }

  $(mapEditorCanvas).on('mousemove', function(e) {
    const { x, y } = getMapCoordinates(e);
    updateCoordDisplay(x, y);
    
    if (x >= 0 && x < MapCols && y >= 0 && y < MapRows) {
      if (isDragging && editorMode === 'place' && tileLibrary.length > 0) {
        map[y][x] = selectedTileIndex;
        drawMap();
      } else if (selectionRect.isSelecting && editorMode === 'select') {
        selectionRect.endX = x;
        selectionRect.endY = y;
        drawMap();
      }
    }
  });

  $(mapEditorCanvas).on('mousedown', function(e) {
    const { x, y } = getMapCoordinates(e);
    
    if (x >= 0 && x < MapCols && y >= 0 && y < MapRows) {
      if (editorMode === 'place' && tileLibrary.length > 0) {
        map[y][x] = selectedTileIndex;
        isDragging = true;
        drawMap();
      } else if (editorMode === 'select') {
        selectionRect.startX = x;
        selectionRect.startY = y;
        selectionRect.endX = x;
        selectionRect.endY = y;
        selectionRect.isSelecting = true;
        drawMap();
      }
    }
  });

  $(mapEditorCanvas).on('mouseup', function() {
    isDragging = false;
    selectionRect.isSelecting = false;
  });

  $(mapEditorCanvas).on('mouseleave', function() {
    isDragging = false;
    selectionRect.isSelecting = false;
  });

  // Zoom Functions
  $('#zoomInBtn').on('click', function() {
    isFitToScreen = false;
    if (TileScale < MAX_TileScale) {
      TileScale = TileScale === 0 ? 1 : TileScale + 1;
      updateMapCanvasSize();
    }
  });

  $('#zoomOutBtn').on('click', function() {
    isFitToScreen = false;
    if (TileScale > MIN_TileScale) {
      TileScale--;
      updateMapCanvasSize();
    }
  });

  $('#zoom1xBtn').on('click', function() {
    isFitToScreen = false;
    TileScale = 1;
    updateMapCanvasSize();
  });

  $('#fitMapBtn').on('click', function() {
    isFitToScreen = true;
    TileScale = 0;
    updateMapCanvasSize();
  });

  // Import PNG for Map Editor
  $('#importTileForMap').on('change', function(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    
    if (tileLibrary.length + files.length > MAX_TILES) {
      alert(`Cannot import ${files.length} tiles. Maximum limit is ${MAX_TILES} tiles (000-1999).\nCurrent: ${tileLibrary.length}/${MAX_TILES}`);
      return;
    }
    
    let loadedCount = 0;
    
    files.forEach((file, fileIndex) => {
      const reader = new FileReader();
      reader.onload = function(evt) {
        const img = new Image();
        img.onload = function() {
          const tileCanvas = document.createElement('canvas');
          tileCanvas.width = OriginalTileSize;
          tileCanvas.height = OriginalTileSize;
          const tileCtx = tileCanvas.getContext('2d');
          
          tileCtx.drawImage(img, 0, 0, OriginalTileSize, OriginalTileSize);
          
          tileLibrary.push({
            image: img,
            name: file.name,
            canvas: tileCanvas
          });
          
          loadedCount++;
          
          if (loadedCount === files.length) {
            selectedTileIndices.clear();
            selectedTileIndex = tileLibrary.length - files.length;
            selectedTileIndices.add(selectedTileIndex);
            
            updateTileGrid();
            drawMap();
            alert(`Added ${files.length} tile(s). Total: ${tileLibrary.length}/${MAX_TILES}`);
          }
        };
        img.src = evt.target.result;
      };
      reader.readAsDataURL(file);
    });
  });

  // Import Map from TXT
  $('#importMapTXT').on('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (tileLibrary.length === 0) {
      alert('Please import some tiles first before loading a map!');
      return;
    }
    
    const reader = new FileReader();
    reader.onload = function(evt) {
      const text = evt.target.result;
      const lines = text.split('\n');
      
      for (let y = 0; y < MapRows; y++) {
        for (let x = 0; x < MapCols; x++) {
          map[y][x] = -1;
        }
      }
      
      let readingMap = false;
      let lineIndex = 0;
      
      for (const line of lines) {
        const trimmed = line.trim();
        
        if (trimmed === '' || trimmed.startsWith('#')) {
          continue;
        }
        
        if (!readingMap) {
          readingMap = true;
        }
        
        if (readingMap && lineIndex < MapRows) {
          const cells = trimmed.split(/\s+/);
          for (let x = 0; x < Math.min(MapCols, cells.length); x++) {
            const cell = cells[x];
            if (cell === '.' || cell === '-1') {
              map[lineIndex][x] = -1;
            } else {
              const tileIndex = parseInt(cell);
              if (!isNaN(tileIndex) && tileIndex >= 0 && tileIndex < tileLibrary.length) {
                map[lineIndex][x] = tileIndex;
              }
            }
          }
          lineIndex++;
        }
        
        if (lineIndex >= MapRows) break;
      }
      
      drawMap();
      alert('Map loaded successfully!');
    };
    reader.readAsText(file);
  });

  $('#clearSelectedAreaBtn').on('click', function() {
    if (selectionRect.startX < 0 || selectionRect.startY < 0 || 
        selectionRect.endX < 0 || selectionRect.endY < 0) {
      alert('No area selected! Use Select Mode to select an area first.');
      return;
    }
    
    const x1 = Math.min(selectionRect.startX, selectionRect.endX);
    const y1 = Math.min(selectionRect.startY, selectionRect.endY);
    const x2 = Math.max(selectionRect.startX, selectionRect.endX);
    const y2 = Math.max(selectionRect.startY, selectionRect.endY);
    
    if (confirm(`Clear the selected area (${x2-x1+1}x${y2-y1+1})?`)) {
      for (let y = y1; y <= y2; y++) {
        for (let x = x1; x <= x2; x++) {
          if (y >= 0 && y < MapRows && x >= 0 && x < MapCols) {
            map[y][x] = -1;
          }
        }
      }
      drawMap();
    }
  });

  // Mode switching
  $('#modePlace').on('click', function() {
    editorMode = 'place';
    $('#modePlace').addClass('active');
    $('#modeSelect').removeClass('active');
    selectionRect.startX = selectionRect.startY = selectionRect.endX = selectionRect.endY = -1;
    drawMap();
  });

  $('#modeSelect').on('click', function() {
    editorMode = 'select';
    $('#modeSelect').addClass('active');
    $('#modePlace').removeClass('active');
    drawMap();
  });
}

// === File Operations ===
function saveMapAsTXT() {
  if (tileLibrary.length === 0) {
    alert('No tiles imported! Import some PNG tiles first.');
    return;
  }
  
  let text = '# Map Data\n';
  text += '# Map size: 50x50 tiles\n';
  text += '# Tile Index to Name mapping (sorted):\n';
  
  sortTileLibrary();
  
  tileLibrary.forEach((tile, idx) => {
    const tileNumber = extractTileNumber(tile.name);
    const displayNumber = tileNumber.toString().padStart(3, '0');
    text += `# ${idx}: ${displayNumber}_${tile.name}\n`;
  });
  text += '\n# Map (50x50):\n';
  
  for (let y = 0; y < MapRows; y++) {
    const row = map[y].map(index => index === -1 ? '.' : index).join(' ');
    text += row + '\n';
  }
  
  const blob = new Blob([text], { type: "text/plain" });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `map_${Date.now()}.txt`;
  link.click();
}

function exportMapAsPNG() {
  if (tileLibrary.length === 0) {
    alert('No tiles imported! Import some PNG tiles first.');
    return;
  }
  
  const exportCanvas = document.createElement('canvas');
  exportCanvas.width = MapCols * OriginalTileSize;
  exportCanvas.height = MapRows * OriginalTileSize;
  const exportCtx = exportCanvas.getContext('2d');
  
  exportCtx.fillStyle = '#222';
  exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);
  
  for (let y = 0; y < MapRows; y++) {
    for (let x = 0; x < MapCols; x++) {
      const tileIndex = map[y][x];
      if (tileIndex >= 0 && tileIndex < tileLibrary.length) {
        const tileCanvas = tileLibrary[tileIndex].canvas;
        exportCtx.drawImage(
          tileCanvas,
          x * OriginalTileSize,
          y * OriginalTileSize,
          OriginalTileSize,
          OriginalTileSize
        );
      }
    }
  }
  
  const link = document.createElement('a');
  link.href = exportCanvas.toDataURL('image/png');
  link.download = `map_${Date.now()}.png`;
  link.click();
}

// === Initialize Everything ===
function initApp() {
  initMapEditorCanvas();
  initEventListeners();
  drawMap();
  updateZoomDisplay();
  updateViewInfo();
  updateSelectedInfo();
  updateTileCount();
  updateTileGrid();
}

// Start the app when page loads
$(document).ready(function() {
  initApp();
});

// Handle window resize
$(window).on('resize', function() {
  if (isFitToScreen || TileScale === 0) {
    updateMapCanvasSize();
  }
});
</script>

</body>
</html>