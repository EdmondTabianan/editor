<!DOCTYPE html>
<html>
<head>
  <title>Map Editor</title>
  <link rel="stylesheet" href="style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<div class="main-container">
  <!-- Left side: Map area -->
  <div class="map-area">
    <!-- Main Controls -->
    <div class="main-controls">
      <!-- Left: File Menu -->
      <div class="control-group">
        <div class="file-menu">
          <button class="file-menu-btn tool-icon" id="fileMenuBtn">
            File â–¼
          </button>
          <div class="file-menu-content" id="fileMenuContent">
            <button class="file-menu-item" id="menuImportTiles">ğŸ“¥ Import Tiles...</button>
            <button class="file-menu-item" id="menuImportMap">ğŸ“‚ Import Map...</button>
            <div class="menu-divider"></div>
            <button class="file-menu-item" id="menuSaveMap">ğŸ’¾ Save Map (Ctrl+S)</button>
            <button class="file-menu-item" id="menuSaveMapAs">ğŸ’¾ Save Map as TXT (Ctrl+Shift+S)</button>
            <button class="file-menu-item" id="menuExportImage">ğŸ–¼ï¸ Export as PNG</button>
            <div class="menu-divider"></div>
            <button class="file-menu-item" id="menuClearMap" style="color: #fc8181;">ğŸ—‘ï¸ Clear Map</button>
          </div>
        </div>
      </div>
      
      <!-- Center: Mode Buttons with Undo/Redo -->
      <div class="control-group">
        <button id="modePlace" class="active tool-icon">ğŸ–Œï¸ Place</button>
        <button id="modeSelect" class="tool-icon">Select</button>
        <button id="fillSelectionBtn" class="btn" title="Fill selection with selected tile">Fill Selection</button>
        <button id="clearSelectedAreaBtn" class="tool-icon">Area</button>
        <button id="deselectAllBtn" class="tool-icon">Deselect</button>
        <button id="gridToggleBtn" class="tool-icon grid-toggle active">Grid</button>
        
        <!-- Add Undo/Redo buttons -->
        <button id="undoBtn" class="tool-icon undo-btn" title="Undo (Ctrl+Z)">â†¶ Undo</button>
        <button id="redoBtn" class="tool-icon redo-btn" title="Redo (Ctrl+Y)">â†· Redo</button>
      </div>
      
      <!-- Right: Zoom Controls -->
      <div class="control-group">
        <!-- <button id="fitMapBtn" class="tool-icon zoom-btn">ğŸ“</button> -->
        <button id="zoomOutBtn" class="tool-icon zoom-btn">â–</button>
        <div class="zoom-display" id="zoomLevel">Fit</div>
        <button id="zoomInBtn" class="tool-icon zoom-btn">â•</button>
        <button id="zoom1xBtn" class="tool-icon zoom-1x">1x</button>
      </div>
    </div>

    <!-- Hidden file inputs - MUST BE BEFORE mapContainer for proper reference -->
    <input type="file" id="importTileForMap" accept="image/png" multiple class="file-input-hidden"/>
    <input type="file" id="importMapTXT" accept=".txt" class="file-input-hidden"/>

    <!-- Map Container -->
    <div class="map-container" id="mapContainer">
      <canvas id="mapEditor"></canvas>
    </div>

    <!-- Fixed overlays - placed outside map container -->
    <div class="coord-display" id="coordDisplay">X:0 Y:0</div>
    <div class="selection-info" id="selectionInfo"></div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <span id="mapInfo">Map: 50Ã—50</span>
      </div>
      <div class="status-item">
        <span id="viewInfo">View: Fit</span>
        <span id="historyStatus" class="history-info"></span>
      </div>
      <div class="status-item">
        <span id="selectedInfo">Selected: 0</span>
      </div>
      <div class="status-item">
        <span id="tileCountInfo">Tiles: 0/2000</span>
      </div>
      <div class="status-item">
        <span id="storageInfo">Storage: 0 KB</span>
      </div>
    </div>
  </div>

  <!-- Right side: Tile palette -->
  <div class="tile-area">
    <div class="tile-header">
      <h2>ğŸ¨ Tile Palette</h2>
      <div class="tile-info">
        <span id="tileInfo">No tiles imported</span>
        <span id="tileStats">0 tiles</span>
      </div>
    </div>

    <!-- Tile Management Buttons -->
    <div class="tile-management">
      <button id="importTilesBtn" class="btn" title="Import PNG tiles">
          Import Tiles
      </button>
      <button id="removeLastTilesBtn" class="btn" title="Remove last imported tiles" disabled>
        Remove Last
      </button>
      <button id="saveTileSetBtn" class="btn" title="Save current tile set">
        Save Set
      </button>
      <button id="loadTileSetBtn" class="btn" title="Load saved tile set">
        Load Set
      </button>
      <button id="saveSessionBtn" class="btn" title="Save current session">
        Save Session
      </button>
      <button id="loadSessionBtn" class="btn" title="Load last session">
        Load Last
      </button>
      <button id="clearSessionBtn" class="btn" title="Clear saved session" disabled>
        Clear Saved
      </button>
      <!-- Add soft reset button if needed -->
      <!-- <button id="softResetBtn" class="btn" title="Reset map but keep tiles">ğŸ”„ Soft Reset</button> -->
      <div id="saveStatus" class="status-info"></div>
    </div>
    
    <div class="import-btn-placeholder" id="importTilesBtnPlaceholder">
      ğŸ“¥ Click to Import Tiles
    </div>
    
    <div class="tile-grid-container" id="tileGridContainer">
      <div class="empty-tiles" id="emptyTiles">
        <div class="icon">ğŸ¨</div>
        <p>No tiles imported yet</p>
        <p>Import PNG files to get started</p>
        <div class="hint">Supports 000-1999 numbered tiles</div>
      </div>
      <div class="tile-grid" id="tileGrid"></div>
    </div>
    
    <div class="tile-limit-warning" id="tileLimitWarning">
      âš ï¸ Tile limit: 2000 (000-1999)
    </div>
    
    <!-- Grid Status Display -->
    <div class="grid-status" id="gridStatus">Grid: ON</div>
  </div>
</div>

<!-- Drag & Drop Overlay -->
<div class="drag-drop-overlay" id="dragDropOverlay">
  <div class="drag-drop-content">
    <div class="drag-drop-icon">ğŸ“¤</div>
    <div class="drag-drop-text">Drop PNG files here</div>
    <div class="drag-drop-hint">Import tiles directly by dragging</div>
  </div>
</div>

<!-- Loading indicator (hidden by default) -->
<div id="loadingIndicator" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 20px; border-radius: 8px; z-index: 9999;">
  Loading...
</div>

<!-- Success message container -->
<div id="successMessageContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;"></div>

<!-- Clear confirmation modal will be injected here -->

<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="edit_map.js"></script>
</body>
</html>